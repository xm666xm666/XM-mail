<VirtualHost *:${APACHE_HTTP_PORT}>
    ServerName _default_
    DocumentRoot /var/www/mail-frontend

    ErrorLog /var/log/httpd/mail-frontend-error.log
    CustomLog /var/log/httpd/mail-frontend-access.log combined

    # 静态资源处理
    <Directory /var/www/mail-frontend>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted
        
        # 禁用认证
        AuthType None
        Satisfy Any
        
        # 启用压缩
        <IfModule mod_deflate.c>
            AddOutputFilterByType DEFLATE text/plain
            AddOutputFilterByType DEFLATE text/html
            AddOutputFilterByType DEFLATE text/xml
            AddOutputFilterByType DEFLATE text/css
            AddOutputFilterByType DEFLATE application/xml
            AddOutputFilterByType DEFLATE application/xhtml+xml
            AddOutputFilterByType DEFLATE application/rss+xml
            AddOutputFilterByType DEFLATE application/javascript
            AddOutputFilterByType DEFLATE application/x-javascript
        </IfModule>
        
        # 缓存控制
        <IfModule mod_expires.c>
            ExpiresActive On
            ExpiresByType text/css "access plus 1 month"
            ExpiresByType application/javascript "access plus 1 month"
            ExpiresByType image/png "access plus 1 month"
            ExpiresByType image/jpg "access plus 1 month"
            ExpiresByType image/jpeg "access plus 1 month"
            ExpiresByType image/gif "access plus 1 month"
            ExpiresByType image/svg+xml "access plus 1 month"
        </IfModule>
    </Directory>

    # WebSocket 代理（必须在普通 API 代理之前）
    ProxyPreserveHost On
    ProxyRequests Off
    
    # 启用代理模块
    <IfModule mod_proxy.c>
        # WebSocket 代理配置 - 使用 mod_proxy_wstunnel
        <Location /api/terminal/ws>
            # 使用 mod_proxy_wstunnel 处理 WebSocket
            <IfModule mod_proxy_wstunnel.c>
                # 使用 ProxyPass 配合 upgrade 参数（Apache 2.4+ 语法）
                ProxyPass http://127.0.0.1:${API_PORT}/api/terminal/ws upgrade=websocket
                ProxyPassReverse http://127.0.0.1:${API_PORT}/api/terminal/ws
            </IfModule>
            
            # 如果没有 mod_proxy_wstunnel，使用 RewriteRule
            <IfModule !mod_proxy_wstunnel.c>
                RewriteEngine On
                RewriteCond %{HTTP:Upgrade} =websocket [NC]
                RewriteCond %{HTTP:Connection} =upgrade [NC]
                RewriteRule ^/?(.*) ws://127.0.0.1:${API_PORT}/api/terminal/ws/$1 [P,L]
                RewriteCond %{HTTP:Upgrade} !=websocket [NC]
                RewriteRule ^/?(.*) http://127.0.0.1:${API_PORT}/api/terminal/ws/$1 [P,L]
            </IfModule>
            
            Require all granted
            
            # 禁用认证
            AuthType None
            Satisfy Any
        </Location>
    </IfModule>

    # API 代理（必须在 WebSocket 配置之后，这样 WebSocket 路径会优先匹配）
    ProxyPreserveHost On
    ProxyRequests Off
    <Location /api/>
        ProxyPass http://127.0.0.1:${API_PORT}/api/
        ProxyPassReverse http://127.0.0.1:${API_PORT}/api/
        Require all granted
        
        # 禁用认证
        AuthType None
        Satisfy Any
    </Location>

    # 上传文件代理（头像等静态文件）
    <Location /uploads/>
        ProxyPass http://127.0.0.1:${API_PORT}/uploads/
        ProxyPassReverse http://127.0.0.1:${API_PORT}/uploads/
        Require all granted
        
        # 禁用认证
        AuthType None
        Satisfy Any
        
        # 设置缓存头
        <IfModule mod_headers.c>
            Header set Cache-Control "public, max-age=31536000"
        </IfModule>
    </Location>

    # Vue Router 支持 - 所有非 API 请求都返回 index.html
    <LocationMatch "^(?!.*\.(css|js|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)).*$">
        RewriteEngine On
        RewriteCond %{REQUEST_URI} !^/api/
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule . /index.html [L]
    </LocationMatch>
</VirtualHost>